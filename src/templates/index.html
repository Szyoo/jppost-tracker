<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>快递追踪器与通知服务控制台</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div id="app" class="container">
      <div class="header">
        <h1>[[ title ]]</h1>
      </div>

      <div class="section">
        <div class="flex-container">
          <div class="flex-child">
            <div class="section service-panel">
              <div class="section-header-row">
                <h2>快递追踪脚本</h2>
              </div>
              <div class="controls">
                <button @click="startScript" :disabled="script.running" class="start">启动脚本</button>
                <button @click="stopScript" :disabled="!script.running" class="stop">停止脚本</button>
                <div class="status-group">
                  <span :class="['status-indicator', { running: script.running, stopped: !script.running }]" title="追踪脚本状态"></span>
                  <span class="status-label">脚本</span>
                  <span
                    :class="['status-indicator', 'keepalive', {
                      running: keepalive.running,
                      stopped: !keepalive.running,
                      ok: keepalive.running
                        && keepalive.last_at
                        && keepalive.last_error == null
                        && keepalive.last_code >= 200 && keepalive.last_code < 400
                        && keepalive.state !== 'pinging',
                      error: keepalive.running
                        && keepalive.last_at
                        && (keepalive.last_error != null || keepalive.last_code < 200 || keepalive.last_code >= 400)
                        && keepalive.state !== 'pinging',
                      pending: keepalive.running
                        && (keepalive.state === 'pinging' || !keepalive.last_at)
                    }]"
                  ></span>
                  <span class="status-label">保活</span>
                </div>
                <div class="keepalive-result" v-if="keepalive.configured">
                  <template v-if="!keepalive.running">
                    保活:停用 · [[ keepalive.url ]]
                  </template>
                  <template v-else>
                    <span v-if="keepalive.state === 'pinging'">保活:ping中…</span>
                    <span v-else>保活:启动中…</span>
                  </template>
                  <template v-else-if="keepalive.last_error == null && keepalive.last_code >= 200 && keepalive.last_code < 400">
                    保活:OK · [[ keepalive.last_at ]] · [[ keepalive.last_code ]]
                  </template>
                  <template v-else>
                    保活:ERR · [[ keepalive.last_at ]] · [[ keepalive.last_error || keepalive.last_code ]]
                  </template>
                </div>
                <div class="keepalive-result" v-else>
                  保活:关闭（未配 PUBLIC_URL）
                </div>
              </div>
              <div class="log-container">
                <h3>追踪脚本实时日志</h3>
                <div class="log-output tracker-log-output" ref="trackerLogOutput">
                  <div v-for="(line, index) in script.logs" :key="index" v-html="line"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex-child">
            <div class="section service-panel">
              <div class="section-header-row">
                <h2>Bark 通知服务</h2>
              </div>

              <div class="remote-panel service-panel-body">
                <div class="tracking-section">
                  <h3>快递单号设置</h3>
                  <div class="tracking-input-row">
                    <label for="trackingNumberInput">快递单号</label>
                    <div class="tracking-input-controls">
                      <input
                        id="trackingNumberInput"
                        type="text"
                        v-model="envVars.TRACKING_NUMBER"
                        placeholder="在此粘贴新的快递单号"
                      />
                      <button type="button" class="icon-btn" @click="pasteTrackingNumber" title="粘贴">
                        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 2H8a2 2 0 0 0-2 2v2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2h2a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Zm-4 18H4V8h8v12Zm4-4h-2V8a2 2 0 0 0-2-2H8V4h8v12Z"/></svg>
                      </button>
                      <button type="button" class="icon-btn" @click="clearTrackingNumber" title="清空">
                        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18v2H3V6Zm2 3h14l-1.2 11.2A2 2 0 0 1 15.8 22H8.2a2 2 0 0 1-2-1.8L5 9Zm5-6h4l1 1h5v2H4V4h5l1-1Z"/></svg>
                      </button>
                      <button type="button" class="refresh-btn apply-tracking" @click="saveEnv">应用</button>
                    </div>
                    <div class="tracking-input-hint">点击“应用”后更新环境变量</div>
                  </div>
                </div>
                <div class="remote-header">
                  <h3>远程 Bark Server 状态</h3>
                </div>
                <div class="remote-refresh-row">
                  <div class="remote-refresh-toggle">
                    <button
                      type="button"
                      :class="['tab-btn', { active: remoteRefreshMode === 'auto' }]"
                      @click="remoteRefreshMode = 'auto'"
                    >自动刷新</button>
                    <button
                      type="button"
                      :class="['tab-btn', { active: remoteRefreshMode === 'manual' }]"
                      @click="remoteRefreshMode = 'manual'"
                    >手动刷新</button>
                  </div>
                  <div class="remote-refresh-right">
                    <button
                      v-if="remoteRefreshMode === 'manual'"
                      type="button"
                      class="refresh-btn full"
                      @click="fetchRemoteBarkStatus"
                      :disabled="remoteBark.loading"
                    >刷新</button>
                    <div v-else class="remote-refresh-interval">
                      <span>间隔</span>
                      <input type="number" min="0" v-model.number="remoteAutoMinDraft" class="time-input" /> 分
                      <input type="number" min="0" max="59" v-model.number="remoteAutoSecDraft" class="time-input" /> 秒
                      <button
                        type="button"
                        class="refresh-btn apply-btn"
                        @click="applyRemoteAutoInterval"
                      >保存</button>
                    </div>
                  </div>
                </div>
                <div class="remote-health-config">
                  <label for="remoteHealthPath">健康检测路径</label>
                  <div class="remote-health-row">
                    <input
                      id="remoteHealthPath"
                      type="text"
                      v-model="envVars.BARK_HEALTH_PATH"
                      placeholder="/ 或 /health"
                    />
                    <button type="button" class="refresh-btn" @click="saveEnv">保存</button>
                  </div>
                  <div class="remote-health-hint">
                    用于本页面远程状态检测，不影响 Render 设置
                  </div>
                </div>
                <div v-if="remoteBark.loading" class="remote-line">正在检查...</div>
                <div v-else>
                  <div class="remote-line">
                    <span class="remote-label">地址:</span>
                    <span>[[ remoteBark.url || '未配置' ]]</span>
                  </div>
                  <div class="remote-line">
                    <span class="remote-label">状态:</span>
                    <span :class="['remote-status', { ok: remoteBark.ok, bad: !remoteBark.ok }]">
                      [[ remoteBark.ok ? '在线' : '离线/冷启动中' ]]
                    </span>
                    <span v-if="remoteBark.status_code">（HTTP [[ remoteBark.status_code ]]）</span>
                  </div>
                  <div class="remote-line" v-if="remoteBark.latency_ms !== null">
                    <span class="remote-label">延迟:</span>
                    <span>[[ remoteBark.latency_ms ]] ms</span>
                  </div>
                  <div class="remote-line" v-if="remoteBark.error">
                    <span class="remote-label">错误:</span>
                    <span class="remote-error">[[ remoteBark.error ]]</span>
                  </div>
                  <div class="remote-line" v-if="remoteBark.checked_at">
                    <span class="remote-label">上次检查:</span>
                    <span>[[ remoteBark.checked_at ]]</span>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <h2>环境变量配置</h2>
        <form @submit.prevent="saveEnv" class="env-form">
          <template v-for="(value, key) in envVars" :key="key">
            <div v-if="key !== 'TRACKING_NUMBER' && key !== 'BARK_URL_ENABLED' && key !== 'CHECK_INTERVAL' && key !== 'BARK_QUERY_PARAMS' && key !== 'BARK_HEALTH_PATH'">
              <label :for="key">[[ key ]] ([[ envDesc[key] ]]):</label>
              <input type="text" :id="key" v-model="envVars[key]" />
            </div>
          </template>

          <div v-if="envVars['CHECK_INTERVAL'] !== undefined">
            <label>CHECK_INTERVAL ([[ envDesc['CHECK_INTERVAL'] ]])</label>
            <div class="inline-field">
              <input type="number" min="0" v-model.number="intervalMin" class="time-input" /> 分
              <input type="number" min="0" max="59" v-model.number="intervalSec" class="time-input" /> 秒
            </div>
          </div>

          <div class="mb-3">
            <label for="BARK_URL_ENABLED">BARK_URL_ENABLED ([[ envDesc['BARK_URL_ENABLED'] ]])</label>
            <input type="checkbox" id="BARK_URL_ENABLED" v-model="includeUrl" />
          </div>

          <div v-if="envVars['BARK_QUERY_PARAMS'] !== undefined" class="bark-params">
            <label for="BARK_QUERY_PARAMS">BARK_QUERY_PARAMS ([[ envDesc['BARK_QUERY_PARAMS'] ]])</label>
            <input type="text" id="BARK_QUERY_PARAMS" v-model="envVars['BARK_QUERY_PARAMS']" class="param-input" />
            <div class="param-desc">下表用于逐项编辑，与上方字符串等同</div>
            <table class="param-table">
              <tr v-for="(val, param) in barkParams" :key="param">
                <td class="param-name">[[ param ]]</td>
                <td class="param-desc">[[ paramOptions[param].description ]]</td>
                <td>
                  <select v-if="paramOptions[param].values.length" v-model="barkParams[param]" class="param-input">
                    <option v-for="item in paramOptions[param].values" :key="item.value" :value="item.value">[[ item.label ]]</option>
                  </select>
                  <input v-else type="text" v-model="barkParams[param]" class="param-input" />
                </td>
                <td><button type="button" @click="removeParam(param)">删除</button></td>
              </tr>
              <tr class="param-add">
                <td colspan="2">
                  <select v-model="newParam" class="param-input">
                    <option disabled value="">选择参数</option>
                    <option v-for="(opt, key) in availableParams" :key="key" :value="key">[[ key ]] - [[ opt.description ]]</option>
                  </select>
                </td>
                <td><button type="button" @click="addParam" :disabled="!newParam">添加参数</button></td>
                <td></td>
              </tr>
            </table>
          </div>

          <button type="submit">保存环境变量</button>
        </form>
        <div v-if="envMessage.text" :class="['message', envMessage.type]">[[ envMessage.text ]]</div>
      </div>
    </div>

    <script id="initial-env" type="application/json">
      {{ env_vars | tojson | safe }}
    </script>
    <script>
      (function () {
        const el = document.getElementById('initial-env');
        const text = el ? el.textContent : '{}';
        window.initialEnvVars = JSON.parse(text || '{}');
      })();
    </script>
    <script src="/static/app.js"></script>
  </body>
</html>
